
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="404Forest">
    <title>现代前端科技解析 —— Javascript Bundler - 404Forest</title>
    <meta name="author" content="Jin">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
    <meta name="description" content="现代的单页应用开发已经离不开 Webpack 类打包工具的帮助。本文将以 Webpack 1 为例解析 Javascript bundler 的工作原理，包括 code splitting。">
<meta property="og:type" content="blog">
<meta property="og:title" content="现代前端科技解析 —— Javascript Bundler">
<meta property="og:url" content="http://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/index.html">
<meta property="og:site_name" content="404Forest">
<meta property="og:description" content="现代的单页应用开发已经离不开 Webpack 类打包工具的帮助。本文将以 Webpack 1 为例解析 Javascript bundler 的工作原理，包括 code splitting。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.404forest.com/imgs/blog/bundler-1.png">
<meta property="og:image" content="http://www.404forest.com/imgs/blog/bundler-2.png">
<meta property="article:published_time" content="2017-10-16T22:45:11.000Z">
<meta property="article:modified_time" content="2025-02-04T23:02:44.260Z">
<meta property="article:author" content="Jin">
<meta property="article:tag" content="Modern web development tech analysis">
<meta property="article:tag" content="现代前端科技解析">
<meta property="article:tag" content="webpack">
<meta property="article:tag" content="javascript bundler">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.404forest.com/imgs/blog/bundler-1.png">
<meta name="twitter:creator" content="@jin5354">
    
    
    
        <meta property="og:image" content="/assets/images/ava.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style.min.css">

    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-66492678-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/%20">404Forest</a>
    </h1>
    
        <a class="header-right-picture" href="/#about">
            <img class="header-picture" src="/assets/images/ava.png"/>
        </a>
    
</header>
            <nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                
                    <img class="sidebar-profile-picture" src="/assets/images/ava.png"/>
                
            </a>
            <span class="sidebar-profile-name">Jin</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/%20"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archive</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/jin5354" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xiaoyanjinx@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <div style="margin-left: 27px;">
        <a target="_blank" rel="noopener" href="https://github.com/jin5354/404forest"><img src="https://img.shields.io/github/stars/jin5354/404forest.svg?style=social&label=Stars"></a>
    </div>
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                <article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            现代前端科技解析 —— Javascript Bundler
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Mon Oct 16 2017 15:45:11 GMT-0700">
	
		    10月 16, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Code/">Code</a>


    
</div>
</div>
    
    <div class="main-content-wrap" style="margin-top: 60px;">索引</div>
    <ol class="main-content-wrap toc-article"><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-1"><a class="main-content-wrap toc-article-link" href="#1-%E5%88%86%E6%9E%90-bundle-js"><span class="main-content-wrap toc-article-text">1. 分析 bundle.js</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-1"><a class="main-content-wrap toc-article-link" href="#2-%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E7%9A%84-bundle-%E5%8A%9F%E8%83%BD"><span class="main-content-wrap toc-article-text">2. 实现基本的 bundle 功能</span></a><ol class="main-content-wrap toc-article-child"><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#2-1-%E8%AF%BB%E5%8F%96-config"><span class="main-content-wrap toc-article-text">2.1 读取 config</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#2-2-%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86"><span class="main-content-wrap toc-article-text">2.2 依赖收集</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#2-3-%E6%BA%90%E7%A0%81-require-%E6%9B%BF%E6%8D%A2"><span class="main-content-wrap toc-article-text">2.3 源码 require 替换</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#2-4-%E6%8B%BC%E8%A3%85%E7%94%9F%E6%88%90"><span class="main-content-wrap toc-article-text">2.4 拼装生成</span></a></li></ol></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-1"><a class="main-content-wrap toc-article-link" href="#3-code-splitting"><span class="main-content-wrap toc-article-text">3. code splitting</span></a><ol class="main-content-wrap toc-article-child"><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#3-1-%E5%8D%95%E7%8B%AC%E6%94%B6%E9%9B%86%E5%BC%82%E6%AD%A5%E4%BE%9D%E8%B5%96"><span class="main-content-wrap toc-article-text">3.1 单独收集异步依赖</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#3-2-%E7%94%9F%E6%88%90-chunk-%E7%B4%A2%E5%BC%95"><span class="main-content-wrap toc-article-text">3.2 生成 chunk 索引</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#3-3-%E8%A1%A5%E5%85%85-require-ensure-%E5%92%8C-webpackJsonp-%E5%87%BD%E6%95%B0"><span class="main-content-wrap toc-article-text">3.3 补充 require.ensure 和 webpackJsonp 函数</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-2"><a class="main-content-wrap toc-article-link" href="#3-4-%E6%8B%BC%E8%A3%85%E7%94%9F%E6%88%90"><span class="main-content-wrap toc-article-text">3.4 拼装生成</span></a></li></ol></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-1"><a class="main-content-wrap toc-article-link" href="#4-%E5%90%8E%E8%AE%B0"><span class="main-content-wrap toc-article-text">4. 后记</span></a></li><li class="main-content-wrap toc-article-item main-content-wrap toc-article-level-1"><a class="main-content-wrap toc-article-link" href="#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="main-content-wrap toc-article-text">5.参考资料</span></a></li></ol>
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>现代的单页应用开发已经离不开 Webpack 类打包工具的帮助。本文将以 Webpack 1 为例解析 Javascript bundler 的工作原理，包括 code splitting。</p>
<a id="more"></a>
<blockquote>
<p>注：<br>原始链接: <a href="https://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/">https://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/</a><br>文章备份: <a href="https://github.com/jin5354/404forest/issues/66" target="_blank" rel="external">https://github.com/jin5354/404forest/issues/66</a></p>
</blockquote>
<h1 id="1-分析-bundle-js"><a href="#1-分析-bundle-js" class="headerlink" title="1. 分析 bundle.js"></a>1. 分析 bundle.js</h1><p>我们创建一个最小化的 bundle 示例，查看打包产物是什么样子：</p>
<p>entry.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</div><div class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>)</div><div class="line"></div><div class="line">a()</div><div class="line">b()</div></pre></td></tr></table></figure></p>
<p>a.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module a function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = a</div></pre></td></tr></table></figure></p>
<p>b.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> c = <span class="built_in">require</span>(<span class="string">'./c.js'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  c()</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module b function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = b</div></pre></td></tr></table></figure></p>
<p>c.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module c function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = c</div></pre></td></tr></table></figure></p>
<p>共 4 个模块，entry、a、b、c，entry.js 为入口。打包后：</p>
<p>bundle.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span>(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;</div><div class="line">  <span class="comment">/******/</span>	<span class="keyword">const</span> installedModules = &#123;&#125;</div><div class="line">  <span class="comment">/******/</span>	<span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">moduleId</span>) </span>&#123;</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">if</span>(installedModules[moduleId]) &#123;</div><div class="line">  <span class="comment">/******/</span>       <span class="keyword">return</span> installedModules[moduleId].exports</div><div class="line">  <span class="comment">/******/</span>    &#125;</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">const</span> <span class="built_in">module</span> = installedModules[moduleId] = &#123;</div><div class="line">  <span class="comment">/******/</span>			exports: &#123;&#125;</div><div class="line">  <span class="comment">/******/</span>		&#125;</div><div class="line">  <span class="comment">/******/</span>		modules[moduleId](<span class="built_in">module</span>, <span class="built_in">module</span>.exports, <span class="built_in">require</span>)</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">return</span> <span class="built_in">module</span>.exports</div><div class="line">  <span class="comment">/******/</span>	&#125;</div><div class="line">  <span class="comment">/******/</span>	<span class="keyword">return</span> <span class="built_in">require</span>(<span class="number">0</span>)</div><div class="line">  <span class="comment">/******/</span>&#125;)<span class="comment">/******/</span>(&#123;</div><div class="line"><span class="comment">/******/</span><span class="number">0</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="comment">/* ./a.js */</span><span class="number">1</span>)</div><div class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="comment">/* ./b.js */</span><span class="number">2</span>)</div><div class="line"></div><div class="line">a()</div><div class="line">b()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span><span class="number">1</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module a function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = a</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span><span class="number">2</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">const</span> c = <span class="built_in">require</span>(<span class="comment">/* ./c.js */</span><span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  c()</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module b function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = b</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span><span class="number">3</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'module c function'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = c</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span>&#125;)</div></pre></td></tr></table></figure></p>
<p>执行该文件，会正常输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">module a <span class="keyword">function</span></div><div class="line">module c <span class="keyword">function</span></div><div class="line">module b <span class="keyword">function</span></div></pre></td></tr></table></figure>
<p>分析 bundle 可知：</p>
<ol>
<li>bundle 为自执行函数，函数接收一个参数：modules</li>
<li>modules 是 object， entry、a、b、c 等所有用到的模块包裹为一个函数。模块中所需的变量 <code>module</code>, <code>require</code> 将由参数传入。模块函数以编号为 key 按顺序挂在其下面。</li>
<li>所有模块内部的 require 函数的参数由相对路径被替换成了模块编号</li>
<li>定义了 require 函数，接收模块编号作为参数。当执行 require 时先寻找 installedModules[模块编号] 是否存在，若不存在，则执行被 require 的模块函数，并将 module.exports 值挂在 installedModules[模块编号] 上。</li>
<li>由上条可知 installedModules 为缓存，这样在多次 require 同一个模块时不必多次执行该模块函数。</li>
<li>自执行函数中通过 require(0) 执行入口js，启动程序</li>
</ol>
<p>简单画一个示例图:</p>
<p><img src="/imgs/blog/bundler-1.png" alt="bundler-1"></p>
<h1 id="2-实现基本的-bundle-功能"><a href="#2-实现基本的-bundle-功能" class="headerlink" title="2. 实现基本的 bundle 功能"></a>2. 实现基本的 bundle 功能</h1><p>可参考 leaf-bundler 的在<a href="https://github.com/jin5354/leaf-bundler/tree/6011f36aa1ac4218b657819ace10f6463e7de7b1" target="_blank" rel="external">这个 commit 时的代码</a>。</p>
<h2 id="2-1-读取-config"><a href="#2-1-读取-config" class="headerlink" title="2.1 读取 config"></a>2.1 读取 config</h2><p>bundler 是命令行程序，我们一般这样用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bundler --config example/example1/bundler.config.js</div></pre></td></tr></table></figure>
<p>bundler.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./entry.js'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>命令行的支持通过 <a href="https://github.com/tj/commander.js" target="_blank" rel="external">commander</a> 或同类模块可以轻松实现。获得 config 文件的相对路径后，直接 <code>require(path.resolve(configPath))</code> 即可拿到 config 文件的内容。此处不赘述，可参考 <a href="https://github.com/jin5354/leaf-bundler/blob/6011f36aa1ac4218b657819ace10f6463e7de7b1/bin/leaf-bundler" target="_blank" rel="external">bin/leaf-bundler</a> 相关代码。</p>
<h2 id="2-2-依赖收集"><a href="#2-2-依赖收集" class="headerlink" title="2.2 依赖收集"></a>2.2 依赖收集</h2><p>依赖收集是 bundle 过程中最关键的一环。我们需要从 entry 开始遍历分析每个模块，收集所有依赖的文件路径等信息，构造出一棵依赖树。</p>
<p>如何从模块中收集依赖？使用正则表达式可以匹配出代码中包含 <code>require</code> 的部分，但正则一是难以过滤<strong>注释</strong>中的代码，二是难以分析复杂的 <code>require</code> 表达式（如 <code>require(&#39;a&#39; + &#39;b&#39;)()</code>）。对于分析代码含义的需求，最恰当的是使用 Javascript Parse 工具，如 <a href="https://github.com/jquery/esprima" target="_blank" rel="external">esprima</a>。</p>
<p>调用 esprima 分析如下代码，会产生一个语法树：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</div><div class="line">a()</div></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"type"</span>: <span class="string">"Program"</span>,</div><div class="line">  <span class="attr">"body"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"VariableDeclaration"</span>,</div><div class="line">      <span class="attr">"declarations"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"VariableDeclarator"</span>,</div><div class="line">          <span class="attr">"id"</span>: &#123;</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"a"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="attr">"init"</span>: &#123;</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"CallExpression"</span>,</div><div class="line">            <span class="attr">"callee"</span>: &#123;</div><div class="line">              <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</div><div class="line">              <span class="attr">"name"</span>: <span class="string">"require"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"arguments"</span>: [</div><div class="line">              &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</div><div class="line">                <span class="attr">"value"</span>: <span class="string">"./a.js"</span>,</div><div class="line">                <span class="attr">"raw"</span>: <span class="string">"'./a.js'"</span></div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"kind"</span>: <span class="string">"const"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"ExpressionStatement"</span>,</div><div class="line">      <span class="attr">"expression"</span>: &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"CallExpression"</span>,</div><div class="line">        <span class="attr">"callee"</span>: &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</div><div class="line">          <span class="attr">"name"</span>: <span class="string">"a"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"arguments"</span>: []</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"sourceType"</span>: <span class="string">"script"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>纵览一下这个 AST 语法树即可发现 esprima 将代码的全部语义都进行了提取。代码包括两句，第一句是变量声明（VariableDeclaration），第二句是表达式（ExpressionStatement）；变量声明时，变量名为 a，赋值内容为函数表达式（CallExpression），函数名为 require，值为字面量（Literal）”./a.js”……</p>
<p>通过深度优先遍历这个 AST ，查找 require 相关表达式，我们就可以准确的识别出某一段代码中的依赖了。具体代码可见 <a href="https://github.com/jin5354/leaf-bundler/blob/6011f36aa1ac4218b657819ace10f6463e7de7b1/src/parse.js" target="_blank" rel="external">parse.js</a>。拿到依赖后，递归对依赖文件进行分析。</p>
<p>由于在之后的流程中需要将 require(‘./a.js’) 替换为模块代码 require(1)，使用 esprima 时还需添加选项 <code>{range: true}</code>，记录 require 的参数的具体位置。从入口文件开始进行依赖分析，随后通过递归，对依赖继续进行分析，直到收集全所有依赖。重点要收集到：模块的绝对路径名（可作为唯一标识符）、模块源码、模块ID、模块的依赖、依赖的绝对路径名、ID和其在源码中的位置。</p>
<p>对第一节的例子进行依赖收集，最终的依赖树如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/entry.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/entry.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./entry.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./a.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/a.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">18</span>,</div><div class="line">          <span class="number">26</span></div><div class="line">        ],</div><div class="line">        <span class="string">"id"</span>: <span class="number">1</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./b.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/b.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">46</span>,</div><div class="line">          <span class="number">54</span></div><div class="line">        ],</div><div class="line">        <span class="string">"id"</span>: <span class="number">2</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"const a = require('./a.js')\nconst b = require('./b.js')\n\na()\nb()\n"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/a.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/a.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./a.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"function a() &#123;\n  console.log('module a function')\n&#125;\n\nmodule.exports = a\n"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/b.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/b.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./b.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./c.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/c.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">18</span>,</div><div class="line">          <span class="number">26</span></div><div class="line">        ],</div><div class="line">        <span class="string">"id"</span>: <span class="number">3</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"const c = require('./c.js')\n\nfunction b() &#123;\n  c()\n  console.log('module b function')\n&#125;\n\nmodule.exports = b\n"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/c.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">3</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example1/c.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./c.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"function c() &#123;\n  console.log('c')\n&#125;\n\nmodule.exports = c\n"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-3-源码-require-替换"><a href="#2-3-源码-require-替换" class="headerlink" title="2.3 源码 require 替换"></a>2.3 源码 require 替换</h2><p>由于最终模块都以 ID 为 key 挂在一个对象上，我们需要将源码中的 <code>require(&#39;./a.js&#39;)</code> 改成 <code>require(1)</code> 来保证 require 的正常工作。在依赖收集阶段，我们已经拿到了每个模块中的 require 的参数的具体位置，只需对源码用 <code>splice</code> 进行替换即可。</p>
<p>特别要注意的是，如果一个模块代码中有多个 require，需要进行多次替换，必须要<strong>从后向前进行替换</strong>。从前进行替换会导致其后的 require 位置发生变动，依赖收集时提供的位置数值就不准确了。替换部分代码可见 <a href="https://github.com/jin5354/leaf-bundler/blob/6011f36aa1ac4218b657819ace10f6463e7de7b1/src/writeSource.js" target="_blank" rel="external">writeSource.js</a>。</p>
<p>以 entry.js 为例，替换前后如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</div><div class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>)</div><div class="line">...</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="comment">/* ./a.js */</span><span class="number">1</span>)</div><div class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="comment">/* ./b.js */</span><span class="number">2</span>)</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="2-4-拼装生成"><a href="#2-4-拼装生成" class="headerlink" title="2.4 拼装生成"></a>2.4 拼装生成</h2><p>拼装最终 bundle 就很简单了，参考第一节的示例进行拼装：</p>
<p>头部：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span>(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;</div><div class="line">  <span class="comment">/******/</span>	<span class="keyword">const</span> installedModules = &#123;&#125;</div><div class="line">  <span class="comment">/******/</span>	<span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">moduleId</span>) </span>&#123;</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">if</span>(installedModules[moduleId]) &#123;</div><div class="line">  <span class="comment">/******/</span>       <span class="keyword">return</span> installedModules[moduleId].exports</div><div class="line">  <span class="comment">/******/</span>    &#125;</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">const</span> <span class="built_in">module</span> = installedModules[moduleId] = &#123;</div><div class="line">  <span class="comment">/******/</span>			exports: &#123;&#125;</div><div class="line">  <span class="comment">/******/</span>		&#125;</div><div class="line">  <span class="comment">/******/</span>		modules[moduleId](<span class="built_in">module</span>, <span class="built_in">module</span>.exports, <span class="built_in">require</span>)</div><div class="line">  <span class="comment">/******/</span>		<span class="keyword">return</span> <span class="built_in">module</span>.exports</div><div class="line">  <span class="comment">/******/</span>	&#125;</div><div class="line">  <span class="comment">/******/</span>	<span class="keyword">return</span> <span class="built_in">require</span>(<span class="number">0</span>)</div><div class="line">  <span class="comment">/******/</span>&#125;)<span class="comment">/******/</span>(&#123;</div></pre></td></tr></table></figure>
<p>循环注入模块：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 伪代码</span></div><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span>&#123;&#123;模块ID&#125;&#125;: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line">&#123;&#123;模块内容&#125;&#125;</div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div></pre></td></tr></table></figure></p>
<p>尾部：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span>&#125;)</div></pre></td></tr></table></figure></p>
<h1 id="3-code-splitting"><a href="#3-code-splitting" class="headerlink" title="3. code splitting"></a>3. code splitting</h1><p>code splitting 将一个 bundle 切成了多个 chunk，且异步 chunk 为懒加载的——执行到 <code>require.ensure</code> 时才拉取并执行。为了实现这个功能，大体思路如下：</p>
<ul>
<li>通过 require.ensure 标识新 chunk</li>
<li>依赖收集时，单独标识异步依赖</li>
<li>执行 require.ensure 时，拉取新 chunk</li>
<li>新 chunk 设计为一个 jsonp 函数，由 <code>webpackJsonp</code> 函数包裹</li>
<li>实现 <code>webpackJsonp</code> 函数，其会将新拉下来的 chunk 中的模块添加到主 modules 上，随后执行 <code>require.ensure</code> 的回调</li>
</ul>
<p>code splitting 相关代码可参考<a href="https://github.com/jin5354/leaf-bundler/tree/11e255aba2399dbe912d7cbba83c20473eb08095" target="_blank" rel="external">这个 commit</a>。</p>
<p>本节的例子会将 <code>entry.js</code> 中的依赖 <code>b</code> 改为异步依赖，其他不变。</p>
<p>entry.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</div><div class="line">a()</div><div class="line"></div><div class="line"><span class="built_in">require</span>.ensure([<span class="string">'./b.js'</span>], () =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>)</div><div class="line">  b()</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h2 id="3-1-单独收集异步依赖"><a href="#3-1-单独收集异步依赖" class="headerlink" title="3.1 单独收集异步依赖"></a>3.1 单独收集异步依赖</h2><p>单独收集 require.ensure 所标识的依赖，并为每个 chunk 赋予 ID。依然使用 <code>esprima</code> 解析出语法树，并对语法树进行递归遍历。对于模块中收集到的依赖，加入字段标识其是否为异步依赖。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/entry.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/entry.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./entry.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./a.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/a.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">18</span>,</div><div class="line">          <span class="number">26</span></div><div class="line">        ],</div><div class="line">        <span class="string">"async"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"id"</span>: <span class="number">1</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./b.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/b.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">88</span>,</div><div class="line">          <span class="number">96</span></div><div class="line">        ],</div><div class="line">        <span class="string">"async"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="string">"id"</span>: <span class="number">2</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"asyncs"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"requires"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="string">"name"</span>: <span class="string">"./b.js"</span>,</div><div class="line">            <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/b.js"</span></div><div class="line">          &#125;</div><div class="line">        ],</div><div class="line">        <span class="string">"namesRange"</span>: [</div><div class="line">          <span class="number">48</span>,</div><div class="line">          <span class="number">58</span></div><div class="line">        ],</div><div class="line">        <span class="string">"chunkId"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"chunks"</span>: [</div><div class="line">          <span class="number">1</span></div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"const a = require('./a.js')\na()\n\nrequire.ensure(['./b.js'], () =&gt; &#123;\n  const b = require('./b.js')\n  b()\n&#125;)\n\n"</span>,</div><div class="line">    <span class="string">"chunkId"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"chunks"</span>: [</div><div class="line">      <span class="number">0</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/a.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/a.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./a.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"function a() &#123;\n  console.log('module a function')\n&#125;\n\nmodule.exports = a\n"</span>,</div><div class="line">    <span class="string">"chunks"</span>: [</div><div class="line">      <span class="number">0</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/b.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/b.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./b.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"./c.js"</span>,</div><div class="line">        <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/c.js"</span>,</div><div class="line">        <span class="string">"nameRange"</span>: [</div><div class="line">          <span class="number">18</span>,</div><div class="line">          <span class="number">26</span></div><div class="line">        ],</div><div class="line">        <span class="string">"async"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"id"</span>: <span class="number">3</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"const c = require('./c.js')\n\nfunction b() &#123;\n  c()\n  console.log('module b function')\n&#125;\n\nmodule.exports = b\n"</span>,</div><div class="line">    <span class="string">"chunks"</span>: [</div><div class="line">      <span class="number">1</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/c.js"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">3</span>,</div><div class="line">    <span class="string">"filename"</span>: <span class="string">"/Users/jin/playground/leaf-bundler/example/example2/c.js"</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"./c.js"</span>,</div><div class="line">    <span class="string">"requires"</span>: [],</div><div class="line">    <span class="string">"asyncs"</span>: [],</div><div class="line">    <span class="string">"source"</span>: <span class="string">"function c() &#123;\n  console.log('c')\n&#125;\n\nmodule.exports = c\n"</span>,</div><div class="line">    <span class="string">"chunks"</span>: [</div><div class="line">      <span class="number">1</span></div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="3-2-生成-chunk-索引"><a href="#3-2-生成-chunk-索引" class="headerlink" title="3.2 生成 chunk 索引"></a>3.2 生成 chunk 索引</h2><p>加入代码分割功能后，生成文件变为多个，每个 chunk 一个 js，需要在生成前根据依赖树进行梳理。具体代码可见 <a href="https://github.com/jin5354/leaf-bundler/blob/11e255aba2399dbe912d7cbba83c20473eb08095/src/collectDeps.js#L95" target="_blank" rel="external">buildTree</a> 部分。</p>
<p>整理后的 chunk 索引如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="string">"chunks"</span>: &#123;</div><div class="line">  <span class="string">"0"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"modules"</span>: &#123;</div><div class="line">      <span class="string">"0"</span>: <span class="string">"include"</span>,</div><div class="line">      <span class="string">"1"</span>: <span class="string">"include"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"1"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"modules"</span>: &#123;</div><div class="line">      <span class="string">"2"</span>: <span class="string">"include"</span>,</div><div class="line">      <span class="string">"3"</span>: <span class="string">"include"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"parents"</span>: [</div><div class="line">      <span class="number">0</span></div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即最终有 2 个 chunk，第一个 chunk 内含 0、1 两个模块，第二个 chunk 内含 2、3 两个模块。</p>
<h2 id="3-3-补充-require-ensure-和-webpackJsonp-函数"><a href="#3-3-补充-require-ensure-和-webpackJsonp-函数" class="headerlink" title="3.3 补充 require.ensure 和 webpackJsonp 函数"></a>3.3 补充 require.ensure 和 webpackJsonp 函数</h2><p>require.ensure 和 webpackJsonp 函数都将添加到最终产物的生成模板中。require.ensure 的主要功能是：根据 chunkID 拉取远程 chunk。webpackJsonp 函数的主要功能是：将拉取下来的 chunk 中的新模块添加到 modules 对象上，随后执行 require.ensure 的回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span> ...</div><div class="line"><span class="comment">/******/</span>		<span class="built_in">require</span>.ensure = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId, callback</span>) </span>&#123;</div><div class="line"><span class="comment">/******/</span>			<span class="keyword">if</span>(installedChunks[chunkId] === <span class="number">1</span>) <span class="keyword">return</span> callback(<span class="built_in">require</span>);</div><div class="line"><span class="comment">/******/</span>			<span class="keyword">if</span>(installedChunks[chunkId] !== <span class="literal">undefined</span>)</div><div class="line"><span class="comment">/******/</span>				installedChunks[chunkId].push(callback)</div><div class="line"><span class="comment">/******/</span>			<span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">/******/</span>				installedChunks[chunkId] = [callback]</div><div class="line"><span class="comment">/******/</span>				<span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>]</div><div class="line"><span class="comment">/******/</span>				<span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</div><div class="line"><span class="comment">/******/</span>				script.type = <span class="string">'text/javascript'</span></div><div class="line"><span class="comment">/******/</span>				script.src = chunkId + <span class="string">'.chunk.js'</span></div><div class="line"><span class="comment">/******/</span>				head.appendChild(script)</div><div class="line"><span class="comment">/******/</span>			&#125;</div><div class="line"><span class="comment">/******/</span>		&#125;;</div><div class="line"><span class="comment">/******/</span>		<span class="built_in">window</span>.webpackJsonp = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId, moreModules</span>) </span>&#123;</div><div class="line"><span class="comment">/******/</span>			<span class="keyword">for</span>(<span class="keyword">var</span> moduleId <span class="keyword">in</span> moreModules)</div><div class="line"><span class="comment">/******/</span>				modules[moduleId] = moreModules[moduleId]</div><div class="line"><span class="comment">/******/</span>			<span class="keyword">var</span> callbacks = installedChunks[chunkId]</div><div class="line"><span class="comment">/******/</span>			installedChunks[chunkId] = <span class="number">1</span></div><div class="line"><span class="comment">/******/</span>			<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++)</div><div class="line"><span class="comment">/******/</span>				callbacks[i](<span class="built_in">require</span>)</div><div class="line"><span class="comment">/******/</span>		&#125;</div><div class="line"><span class="comment">/******/</span> ...</div></pre></td></tr></table></figure>
<h2 id="3-4-拼装生成"><a href="#3-4-拼装生成" class="headerlink" title="3.4 拼装生成"></a>3.4 拼装生成</h2><p>根据 3.2 节的 chunk 索引，每一个 chunk 都要生成一个 js 文件。第一个 chunk 为自执行函数，添加了 require.ensure 和 webpackJsonp 两个工具函数，其他结构不变；其他 chunk 都是一个 webpackJsonp 函数。</p>
<p>webpackJsonp chunk 模板：</p>
<p>头部：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//伪代码</span></div><div class="line"><span class="comment">/*****/</span>webpackJsonp(&#123;&#123;chunkID&#125;&#125;, &#123;</div></pre></td></tr></table></figure></p>
<p>循环注入所有模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span>&#123;&#123;模块ID&#125;&#125;: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, require</span>) </span>&#123;</div><div class="line"></div><div class="line">&#123;&#123;模块代码&#125;&#125;</div><div class="line"></div><div class="line"><span class="comment">/******/</span>&#125;,</div></pre></td></tr></table></figure>
<p>尾部：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******/</span></div><div class="line"><span class="comment">/******/</span>&#125;)</div></pre></td></tr></table></figure></p>
<p>流程图：</p>
<p><img src="/imgs/blog/bundler-2.png" alt="bundler-2"></p>
<h1 id="4-后记"><a href="#4-后记" class="headerlink" title="4. 后记"></a>4. 后记</h1><p>webpack 的构建环节着实多，本想事无巨细的列出各部分代码，恐怕该文长度会大大膨胀，又无意将 webpack 拓展为系列，所以本文仅列出环节核心思路，不再逐个方法做示例。</p>
<p>loader 负责对各种类型的模块进行预处理，实质是一个字符串处理函数，输入字符串，输出字符串。require css 文件，或者图片这些在 commonJS 规范中不支持的操作，都是因为预先由 loader 将资源转换成 JS Module 才得以实现。例如 require css 文件的效果是将该段 css 包裹在 <code>&lt;style&gt;</code> 标签中打入 <code>&lt;head&gt;</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'test.css'</span>) <span class="comment">// .test&#123;font-size: 18px;&#125;</span></div></pre></td></tr></table></figure>
<p>实际会被 loader 转换为类似下文的结构：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(addStyle(style))</div><div class="line"></div><div class="line"><span class="comment">//由于复用，addStyle 和 style 也是从其他文件 require 而来，形如 require(require(1)(require(2)))</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addStyle</span>(<span class="params">cssCode</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> styleElement = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</div><div class="line">  styleElement.type = <span class="string">'text/css'</span></div><div class="line">  <span class="keyword">if</span>(styleElement.styleSheet) &#123;</div><div class="line">    styleElement.styleSheet.cssText = cssCode</div><div class="line">  &#125;<span class="keyword">else</span> &#123;</div><div class="line">    styleElement.appendChild(<span class="built_in">document</span>.createTextNode(cssCode))</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(styleElement)</div><div class="line">&#125;</div><div class="line"></div><div class="line">style = <span class="string">`.test&#123;font-size: 18px;&#125;`</span></div></pre></td></tr></table></figure></p>
<p>而 plugin 负责处理 loader 做不了的事情。webpack 内部有一套生命周期，plugin 可以在生命周期的各个环节拿到数据并进行处理。具体生命周期可参见 <a href="https://webpack.js.org/api/compiler/#event-hooks" target="_blank" rel="external">Compiler</a>。</p>
<h1 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5.参考资料"></a>5.参考资料</h1><ol>
<li><a href="https://github.com/youngwind/blog/issues/99" target="_blank" rel="external">webpack源码学习系列之一：如何实现一个简单的webpack</a></li>
<li><a href="https://github.com/youngwind/blog/issues/100" target="_blank" rel="external">webpack源码学习系列之二：code-splitting（代码切割）</a></li>
<li><a href="https://github.com/youngwind/blog/issues/101" target="_blank" rel="external">webpack源码学习系列之三：loader 机制</a></li>
<li><a href="https://webpack.js.org/contribute/writing-a-plugin/" target="_blank" rel="external">Writing a Plugin</a></li>
<li><a href="http://taobaofed.org/blog/2016/09/09/webpack-flow/" target="_blank" rel="external">细说 webpack 之流程篇</a></li>
</ol>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Modern-web-development-tech-analysis/" rel="tag">Modern web development tech analysis</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/javascript-bundler/" rel="tag">javascript bundler</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/webpack/" rel="tag">webpack</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E7%A7%91%E6%8A%80%E8%A7%A3%E6%9E%90/" rel="tag">现代前端科技解析</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/04/09/3D-Math-Primer-for-Graphics-And-Game-Development/"  data-tooltip="《3D 数学基础》——脑图笔记">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/09/27/use-code-splitting-with-prefetch-to-improve-spa-web-page-load-performance/" data-tooltip="代码分割结合 Prefetch 完美优化单页应用加载性能">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.404forest.com/2017/10/16/modern-web-development-tech-analysis-javascript-bundler/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Jin. All Rights Reserved.
    </span>
    <a class="copyrights" target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">
        浙ICP备18012561号
    </a>
</footer>

            </div>
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/ava.png"/>
        
            <h4 id="about-card-name">Jin</h4>
        
            <h5 id="about-card-bio">Interested in Web Development/Typography/Japanese.</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                WebDeveloper
            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Beijing
            </h5>
        
    </div>
</div>

        <div id="cover" style="background-image:url('/assets/images/bg4.jpg');"></div>
    </body>
    <!--SCRIPTS-->

<script src="/assets/js/script.min.js"></script>

<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = '404forest';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','ZkJM8hxyxxLens-VGG__','2.0.0');
    </script>


</html>
